# claude-nagger 設定ファイル

# セッション開始時設定
session_startup:
  enabled: true
  messages:
    first_time:
      title: "プロジェクトセットアップ"
      main_text: |
        以下を1つ1つ丁寧に確認し､遵守することを宣言せよ
        違反が発生した場合あなたは失職する
        前提:
        [ ] hookブロック後はリトライ(1回限り通知のため2回目は通過する)
        コミュニケーション規約:
        あなたは選択肢がある場合は必ずオーナに選択肢を提示し､オーナーの指示を仰ぐこと｡その際は各選択肢のpro/conを提示すること
        委譲規約:
        [ ] あなたは実作業を行わず､直接作業せず、チームメンバー（Agent Teams）へ委譲する（コンテクスト節約のため）
        [ ] SendMessage通信はsendmessage_guardがissue_idパターンを強制（手動チェック不要）。成果物はRedmineチケット経由でレビューする
        [ ] [要判断]フラグは優先対応
        TiDD規約:
        [ ] 意思決定の経緯・意図を都度Redmineチケットコメントに記録する
        [ ] Redmineに作業コンテクストを残すことに全力を尽くす
        標準ワークフロー:
        要件定義 → scribeメンバー（チケット起票・タスク分解）
        技術調査 → researcherメンバー（並列調査・結果集約）
        意思決定 → オーナにpro/con提示
        実装     → coderメンバー（並列実装・完了集約）
        テスト   → testerメンバー（テスト実行・結果確認）
        受入     → オーナ確認 → scribeメンバーでクローズ
      severity: "block"

    # 2回目以降（継続セッション）
    repeated:
      title: "協働規約再確認"
      main_text: |
        以下の規約を確認し遵守することを宣言せよ｡規約違反が発覚した場合､あなたは失職する
        [ ] あなたは選択肢がある場合は必ずオーナに選択肢を提示し､オーナーの指示を仰ぐこと｡その際は各選択肢のpro/conを提示すること
        [ ] hookブロック後はリトライ(1回限り通知)
        [ ] SendMessage通信はsendmessage_guardがissue_idパターンを強制（手動チェック不要）。成果物はRedmineチケット経由でレビューする
        [ ] [要判断]フラグは優先対応
        [ ] 意思決定はRedmineコメントに記録する
        [ ] Redmineに作業コンテクストを残すことに全力を尽くす
      severity: "block"

  # subagent別override設定
  # ※ Leader向けではなく、subagent自身に直接ブロッキング通知される
  # 仕組み: SubagentStart hook → マーカー作成 → 次のPreToolUseでsubagentをブロック
  # 解決順序: base(上記) → subagent_default → subagent_types.{type}
  # namespaced対応: "my-plugin:coder" → "coder" にフォールバック
  # 命名規約: Agent Teamsメンバーのnameはsubagent_typesのキーと一致させること
  #   例: name="coder" → subagent_types.coder にマッチ
  overrides:
    subagent_default:
      messages:
        first_time:
          title: "subagent規約"
          main_text: |
            [ ] hookブロック後はリトライ(1回限り通知)
            [ ] 作業完了後に結果を報告すること
            [ ] 判断が必要な場合は実装せず報告すること
    subagent_types:
      Explore:
        enabled: false
      Plan:
        enabled: false
      Bash:
        messages:
          first_time:
            title: "Bash subagent規約"
            main_text: |
              [ ] 破壊的コマンド禁止
      coder:
        messages:
          first_time:
            title: "coder subagent規約"
            main_text: |
              [ ] チケット番号(issue_{id})をコミットメッセージに含めること
              [ ] 指示されたスコープ外のファイルを編集しないこと
              [ ] 判断が必要な場合は実装せず報告すること
              [ ] 完了時に変更内容・コミットハッシュを報告すること
              [ ] 報告=チケットコメント（add_issue_comment_tool使用）
              ツール規約:
              [ ] ファイル操作にはserena MCPツールを優先使用すること
      scribe:
        messages:
          first_time:
            title: "scribe subagent規約"
            main_text: |
              [ ] Redmineチケット操作のみ行うこと
              [ ] コード変更は行わないこと
      tester:
        messages:
          first_time:
            title: "tester subagent規約"
            main_text: |
              [ ] 仕様からテストを設計すること（実装詳細に依存しない）
              [ ] テスト結果・失敗箇所・再現手順を報告すること
              [ ] プロダクションコードを編集しないこと（テストコード・manual_specのみ編集可）
              [ ] 報告=チケットコメント（add_issue_comment_tool使用）
              ツール規約:
              [ ] ファイル操作にはserena MCPツールを優先使用すること

# SendMessageガード設定（Redmine基盤通信強制）
# 毎回検査。違反時のみblock、合格時は無通知通過
sendmessage_guard:
  enabled: true
  pattern: "issue_\\d+"
  max_content_length: 100
  exempt_types:
    - shutdown_request
    - shutdown_response
    - plan_approval_response
  # block_message: ブロック時メッセージテンプレート（カスタマイズ可）
  # プレースホルダー: {violation} {pattern} {max_length}
  # リテラル波括弧は {{ }} でエスケープ
  # block_message: |
  #   SendMessage規約違反
  #   違反: {violation}
  #   パターン: {pattern}, 最大文字数: {max_length}

# leader行動制約設定（subagent存在時のleader直接作業ブロック）
# subagentがアクティブな場合、leaderのソースコード直接操作をブロック
# leader_constraint:
#   enabled: true
#   blocked_tools:
#     - Read
#     - Edit
#     - Write
#     - Grep
#     - Glob
#   source_paths:
#     - "src/"
#     - "tests/"
#   exempt_patterns:
#     - "*.md"
#     - "config.yaml"
#     - ".claude/"
#     - "docs/"
#     - "settings.json"
#   block_message: |
#     ソースコード操作はsubagentに委譲してください。
#     調査→researcher、実装→coder、テスト→tester

# コンテキスト管理設定
context_management:
  reminder_thresholds:
    light_warning: 30000
    medium_warning: 60000
    critical_warning: 100000

# suggest-rules設定（セッション終了時の規約提案機能）
suggest_rules:
  enabled: true  # false: 規約提案機能を無効化

# デバッグ設定
debug:
  enable_logging: true
